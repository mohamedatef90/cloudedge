

<div class="relative rounded-xl p-6 bg-white dark:bg-slate-800 shadow">
  <!-- Header -->
  <div class="flex flex-wrap justify-between items-center gap-4 pb-4 mb-4 border-b border-gray-200 dark:border-slate-700">
    <div>
      <h1 class="text-2xl font-bold text-[#293c51] dark:text-gray-200">Groups</h1>
      <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Manage your groups here.</p>
    </div>
  </div>
  
  <!-- Actions Bar -->
  <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
      <div class="flex items-center gap-2">
        <button (click)="handleAddGroupClick()" [disabled]="isAddingGroup()" class="bg-[#679a41] text-white px-4 py-2 rounded-md text-sm font-semibold hover:bg-[#537d34] transition-all duration-200 ease-in-out flex items-center shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
          <app-icon name="fas fa-plus" className="mr-2 text-xs"></app-icon> ADD GROUP
        </button>
        <button (click)="handleToggleExpandAll()" class="bg-transparent border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-700 px-3 py-1.5 rounded-md text-sm font-semibold">
            {{ expandedRows().length === filteredGroups().length ? 'COLLAPSE ALL' : 'EXPAND ALL' }}
        </button>
      </div>
      <div class="flex items-center gap-2">
          <div class="relative w-full sm:max-w-xs">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <app-icon name="fas fa-search" className="text-gray-400" />
            </div>
            <input 
              type="text" 
              [ngModel]="searchTerm()"
              (ngModelChange)="searchTerm.set($event)"
              placeholder="Search by name or description..."
              class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md leading-5 bg-white dark:bg-slate-700 text-gray-900 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-[#679a41] dark:focus:ring-[#8cc866] focus:border-[#679a41] dark:focus:border-[#8cc866] sm:text-sm"
            />
          </div>
          <button (click)="handleRefresh()" [disabled]="isRefreshing()" class="p-2 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-slate-700 disabled:opacity-50">
              <app-icon name="fas fa-sync-alt" [className]="isRefreshing() ? 'animate-spin' : ''" />
          </button>
          <button (click)="openFilterPanel()" type="button" class="relative bg-transparent border border-[#679a41] text-[#679a41] dark:border-emerald-400 dark:text-emerald-400 hover:bg-[#679a41]/10 dark:hover:bg-emerald-400/10 px-4 py-2 rounded-md text-sm font-semibold transition-all duration-200 ease-in-out flex items-center shadow-sm">
            <app-icon name="fas fa-filter" className="mr-2" />
            Filters
            @if (activeFilterCount() > 0) {
              <span class="absolute -top-1.5 -right-1.5 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs text-white ring-2 ring-white dark:ring-[#f8f8f8]">{{ activeFilterCount() }}</span>
            }
          </button>
      </div>
  </div>

  <!-- Table -->
  <div class="border rounded-lg dark:border-gray-700">
      <table class="min-w-full w-full divide-y divide-gray-200 dark:divide-gray-700 table-fixed">
          <thead class="bg-gray-50 dark:bg-slate-700">
              <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase w-[40%]">Name</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase w-[15%]">
                      <div class="flex items-center">Type <app-icon name="fas fa-info-circle" className="ml-1 text-gray-400" title="Type of group" /></div>
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase w-[15%]">Compute Members</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase w-[15%]">Where Used</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase w-[15%]">Status</th>
              </tr>
          </thead>
          <tbody class="bg-white dark:bg-slate-800 divide-y divide-gray-200 dark:divide-gray-700">
            @if (isAddingGroup()) {
              <tr class="bg-green-50/50 dark:bg-green-900/10 animate-fade-in">
                  <td class="px-4 py-3 text-sm font-medium text-[#293c51] dark:text-gray-200">
                      <div class="flex items-center gap-3">
                          <div class="flex items-center gap-1 text-gray-400 invisible">
                              <div class="relative"><button class="p-2"><app-icon name="fas fa-ellipsis-v" className="cursor-pointer"></app-icon></button></div>
                              <button><app-icon name="fas fa-chevron-right"></app-icon></button>
                          </div>
                          <div class="flex items-center gap-2 w-full">
                              <app-icon name="fas fa-plus" class="text-[#679a41] dark:text-[#8cc866]"></app-icon>
                              <input [(ngModel)]="newGroupForm().name" (keydown.enter)="handleSaveNewGroup()" placeholder="Enter group name" class="w-full bg-transparent border-b border-gray-300 dark:border-slate-600 focus:border-[#679a41] dark:focus:border-[#8cc866] focus:ring-0 py-1 text-sm">
                          </div>
                      </div>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">Generic</td>
                  <td class="px-4 py-3 text-sm">--</td>
                  <td class="px-4 py-3 text-sm">--</td>
                  <td class="px-4 py-3 text-sm">
                      <div class="flex items-center gap-2 text-gray-400 dark:text-gray-500">
                          <app-icon name="fas fa-circle-notch" class="animate-spin"></app-icon>
                          <span class="font-semibold">Pending</span>
                      </div>
                  </td>
              </tr>
              <tr class="bg-white dark:bg-slate-800 animate-fade-in">
                  <td colspan="5" class="p-4">
                      <div class="grid grid-cols-3 gap-4 text-sm">
                          <div>
                              <p class="font-semibold text-gray-600 dark:text-gray-300">Description</p>
                              <textarea [(ngModel)]="newGroupForm().description" placeholder="Group description..." class="w-full mt-1 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-md py-1 px-2 focus:border-[#679a41] dark:focus:border-[#8cc866] focus:ring-1 focus:ring-[#679a41] dark:focus:ring-[#8cc866] text-sm" rows="2"></textarea>
                          </div>
                          <div>
                              <p class="font-semibold text-gray-600 dark:text-gray-300">Tags</p>
                              <p class="mt-1 text-gray-400">0</p>
                          </div>
                          <div class="flex items-end justify-end gap-2">
                              <button (click)="handleSaveNewGroup()" [disabled]="!newGroupForm().name.trim()" class="bg-[#679a41] text-white px-4 py-2 rounded-md text-sm font-semibold hover:bg-[#537d34] disabled:opacity-50">SAVE</button>
                              <button (click)="handleCancelNewGroup()" class="bg-transparent text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 px-4 py-2 rounded-md text-sm font-semibold border border-gray-300 dark:border-slate-600">CANCEL</button>
                          </div>
                      </div>
                  </td>
              </tr>
            }
            @for (group of filteredGroups(); track group.id) {
              @if (editingGroupId() !== group.id) {
                <tr class="bg-gray-50 dark:bg-slate-700/50 hover:bg-gray-100 dark:hover:bg-slate-700 h-[52px]">
                    <td class="px-4 py-3 text-sm font-medium text-[#293c51] dark:text-gray-200">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-1 text-gray-400">
                                <div class="relative">
                                    <button
                                        (click)="toggleActionMenu($event, group.id)"
                                        [attr.data-menu-button-id]="group.id"
                                        class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-[#679a41]">
                                        <app-icon name="fas fa-ellipsis-v" className="cursor-pointer" />
                                    </button>
                                    @if (openMenuId() === group.id) {
                                      <div #menuRef class="absolute left-0 mt-2 w-32 bg-white dark:bg-slate-700 rounded-md shadow-lg z-10 ring-1 ring-black ring-opacity-5 dark:ring-slate-600">
                                          <ul class="py-1">
                                              <li><button (click)="handleStartEdit(group); openMenuId.set(null)" [disabled]="group.isSystemDefined || group.isLocked" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-600 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"><app-icon name="fas fa-pencil-alt" /> Edit</button></li>
                                              <li><button (click)="handleOpenDeleteModal(group)" [disabled]="group.isSystemDefined || group.isLocked" class="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:text-gray-400 disabled:dark:text-gray-500 disabled:hover:bg-transparent"><app-icon name="fas fa-trash-alt" /> Delete</button></li>
                                          </ul>
                                      </div>
                                    }
                                </div>
                                <button (click)="handleToggleRow(group.id)">
                                    <app-icon [name]="expandedRows().includes(group.id) ? 'fas fa-chevron-down' : 'fas fa-chevron-right'" />
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                @if (group.isLocked) {
                                  <app-icon name="fas fa-lock" className="text-gray-500" title="Locked"/>
                                }
                                <span>{{ group.name }}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">{{ group.type }}</td>
                    <td class="px-4 py-3 text-sm">
                      <button (click)="handleOpenViewMembers(group.name)" class="p-0 h-auto text-[#679a41] dark:text-[#8cc866] hover:underline bg-transparent border-none">View Members</button>
                    </td>
                    <td class="px-4 py-3 text-sm">
                      <button (click)="handleOpenWhereUsedModal(group)" class="p-0 h-auto text-[#679a41] dark:text-[#8cc866] hover:underline bg-transparent border-none">Where Used</button>
                    </td>
                    <td class="px-4 py-3 text-sm">
                      @switch (group.status) {
                        @case ('Success') {
                          <div class="flex items-center gap-2 text-green-600 dark:text-green-400">
                              <app-icon name="fas fa-check-circle" />
                              <span class="font-semibold">Success</span>
                          </div>
                        }
                        @case ('Pending') {
                          <div class="flex items-center gap-2 text-yellow-500 dark:text-yellow-400">
                              <app-icon name="fas fa-circle-notch" class="animate-spin" />
                              <span class="font-semibold">Pending</span>
                          </div>
                        }
                        @case ('Error') {
                          <div class="flex items-center gap-2 text-red-600 dark:text-red-400">
                              <app-icon name="fas fa-exclamation-circle" />
                              <span class="font-semibold">Error</span>
                          </div>
                        }
                      }
                    </td>
                </tr>
                @if (expandedRows().includes(group.id)) {
                  <tr class="bg-white dark:bg-slate-800">
                      <td colspan="5" class="p-4">
                          <div class="grid grid-cols-3 gap-4 text-sm">
                              <div>
                                  <p class="font-semibold text-gray-600 dark:text-gray-300">Description</p>
                                  <p>{{ group.description }}</p>
                              </div>
                              <div>
                                  <p class="font-semibold text-gray-600 dark:text-gray-300">Tags</p>
                                  <p>{{ group.tags }}</p>
                              </div>
                              <div>
                                  <button class="p-0 h-auto text-[#679a41] dark:text-[#8cc866] hover:underline bg-transparent border-none">VIEW RELATED GROUPS</button>
                              </div>
                          </div>
                      </td>
                  </tr>
                }
              } @else {
                <!-- Inline Edit Form -->
                <tr class="bg-green-50/50 dark:bg-green-900/10 animate-fade-in">
                    <td class="px-4 py-3 text-sm font-medium">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-1 text-gray-400 invisible">
                                <div class="relative"><button class="p-2"><app-icon name="fas fa-ellipsis-v" className="cursor-pointer"></app-icon></button></div>
                                <button><app-icon name="fas fa-chevron-right"></app-icon></button>
                            </div>
                            <div class="flex items-center gap-2 w-full">
                                <app-icon name="fas fa-pencil-alt" class="text-[#679a41] dark:text-[#8cc866]"></app-icon>
                                <input [(ngModel)]="editGroupForm().name" (keydown.enter)="handleSaveEdit()" (keydown.escape)="handleCancelEdit()" placeholder="Enter group name" class="w-full bg-transparent border-b border-gray-300 dark:border-slate-600 focus:border-[#679a41] dark:focus:border-[#8cc866] focus:ring-0 py-1 text-sm">
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">{{ group.type }}</td>
                    <td class="px-4 py-3 text-sm">--</td>
                    <td class="px-4 py-3 text-sm">--</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex items-center gap-2 text-yellow-500 dark:text-yellow-400">
                            <app-icon name="fas fa-circle-notch" class="animate-spin"></app-icon>
                            <span class="font-semibold">Editing</span>
                        </div>
                    </td>
                </tr>
                <tr class="bg-white dark:bg-slate-800 animate-fade-in">
                    <td colspan="5" class="p-4">
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <p class="font-semibold text-gray-600 dark:text-gray-300">Description</p>
                                <textarea [(ngModel)]="editGroupForm().description" placeholder="Group description..." class="w-full mt-1 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-md py-1 px-2 focus:border-[#679a41] dark:focus:border-[#8cc866] focus:ring-1 focus:ring-[#679a41] dark:focus:ring-[#8cc866] text-sm" rows="2"></textarea>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-600 dark:text-gray-300">Tags</p>
                                <p class="mt-1 text-gray-400">{{ group.tags }}</p>
                            </div>
                            <div class="flex items-end justify-end gap-2">
                                <button (click)="handleSaveEdit()" [disabled]="!editGroupForm().name.trim()" class="bg-[#679a41] text-white px-4 py-2 rounded-md text-sm font-semibold hover:bg-[#537d34] disabled:opacity-50">SAVE</button>
                                <button (click)="handleCancelEdit()" class="bg-transparent text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 px-4 py-2 rounded-md text-sm font-semibold border border-gray-300 dark:border-slate-600">CANCEL</button>
                            </div>
                        </div>
                    </td>
                </tr>
              }
            } @empty {
              <tr>
                <td colspan="5" class="text-center p-6 text-gray-500 dark:text-gray-400">
                  <app-icon name="fas fa-search" className="text-3xl mb-2"></app-icon>
                  <p>No groups found.</p>
                </td>
              </tr>
            }
          </tbody>
      </table>
  </div>

  <!-- Filter Panel -->
  <app-filter-panel [isOpen]="isFilterPanelOpen()" (close)="closeFilterPanel()" (apply)="applyFilters()" (clear)="clearFilters()">
    <div class="space-y-6">
      <div>
        <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300">Type</h3>
        <div class="mt-2 space-y-2">
          @for(type of groupTypes; track type) {
            <label class="flex items-center">
              <input type="radio" name="group-type" [value]="type" [checked]="tempFilters().type === type" (change)="updateTempFilterType(type)" class="h-4 w-4 text-[#679a41] border-gray-300 focus:ring-[#537d34]">
              <span class="ml-3 text-sm text-gray-600 dark:text-gray-400">{{ type === 'all' ? 'All' : type }}</span>
            </label>
          }
        </div>
      </div>
      <div>
        <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300">Status</h3>
        <div class="mt-2 space-y-2">
          @for(status of groupStatuses; track status) {
            <label class="flex items-center">
              <input type="radio" name="group-status" [value]="status" [checked]="tempFilters().status === status" (change)="updateTempFilterStatus(status)" class="h-4 w-4 text-[#679a41] border-gray-300 focus:ring-[#537d34]">
              <span class="ml-3 text-sm text-gray-600 dark:text-gray-400">{{ status === 'all' ? 'All' : status }}</span>
            </label>
          }
        </div>
      </div>
      <div>
        <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300">Properties</h3>
        <div class="mt-2 space-y-2">
          <label class="flex items-center">
            <input type="checkbox" [checked]="tempFilters().isSystemDefined" (change)="updateTempFilterSystemDefined($any($event.target).checked)" class="h-4 w-4 rounded text-[#679a41] border-gray-300 focus:ring-[#537d34]">
            <span class="ml-3 text-sm text-gray-600 dark:text-gray-400">System Defined</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" [checked]="tempFilters().isLocked" (change)="updateTempFilterLocked($any($event.target).checked)" class="h-4 w-4 rounded text-[#679a41] border-gray-300 focus:ring-[#537d34]">
            <span class="ml-3 text-sm text-gray-600 dark:text-gray-400">Locked</span>
          </label>
        </div>
      </div>
    </div>
  </app-filter-panel>

  <!-- Modals -->
  <app-view-members-modal [isOpen]="isViewMembersModalOpen()" [groupData]="viewingGroupData()" (close)="isViewMembersModalOpen.set(false)"></app-view-members-modal>
  <app-where-used-modal [isOpen]="isWhereUsedModalOpen()" [group]="selectedGroupForModal()" (close)="isWhereUsedModalOpen.set(false)"></app-where-used-modal>
  <app-advanced-delete-confirmation-modal
    [isOpen]="isDeleteModalOpen()"
    itemType="Group"
    [itemName]="groupToDelete()?.name || ''"
    (close)="handleCloseDeleteModal()"
    (confirm)="handleConfirmDelete()">
  </app-advanced-delete-confirmation-modal>

</div>