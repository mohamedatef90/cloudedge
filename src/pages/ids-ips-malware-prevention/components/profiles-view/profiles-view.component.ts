
import { ChangeDetectionStrategy, Component, computed, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { IconComponent } from '../../../../components/icon/icon.component';
import { IdsIpsProfile } from '../../types';
import { MOCK_IDS_IPS_PROFILES_DATA } from '../../mock-data';
import { PaginationComponent } from '../pagination/pagination.component';

@Component({
  selector: 'app-profiles-view',
  templateUrl: './profiles-view.component.html',
  styleUrls: ['./profiles-view.component.css'],
  changeDetection: ChangeDetectionStrategy.OnPush,
  imports: [CommonModule, FormsModule, IconComponent, PaginationComponent],
})
export class ProfilesViewComponent {
  profiles = signal<IdsIpsProfile[]>(MOCK_IDS_IPS_PROFILES_DATA);
  filterTerm = signal('');
  currentPage = signal(1);
  rowsPerPage = signal(10);
  isRefreshing = signal(false);
  selectedProfiles = signal<string[]>([]);

  filteredProfiles = computed(() => {
    const term = this.filterTerm().toLowerCase();
    if (!term) return this.profiles();
    return this.profiles().filter(p =>
      p.name.toLowerCase().includes(term) ||
      p.description.toLowerCase().includes(term)
    );
  });

  paginatedProfiles = computed(() => {
    const startIndex = (this.currentPage() - 1) * this.rowsPerPage();
    return this.filteredProfiles().slice(startIndex, startIndex + this.rowsPerPage());
  });

  areAllOnPageSelected = computed(() => {
    const paginated = this.paginatedProfiles();
    if (paginated.length === 0) return false;
    return paginated.every(p => this.selectedProfiles().includes(p.id));
  });

  handleRefresh(): void {
    this.isRefreshing.set(true);
    setTimeout(() => this.isRefreshing.set(false), 1000);
  }

  toggleProfile(profileId: string): void {
    this.profiles.update(prev =>
      prev.map(p => p.id === profileId ? { ...p, isExpanded: !p.isExpanded } : p)
    );
  }

  toggleExpandAll(): void {
    const areSomeCollapsed = this.profiles().some(p => !p.isExpanded);
    this.profiles.update(prev => prev.map(p => ({ ...p, isExpanded: areSomeCollapsed })));
  }

  handleSelectOne(id: string, checked: boolean): void {
    this.selectedProfiles.update(prev => checked ? [...prev, id] : prev.filter(pId => pId !== id));
  }

  handleSelectAll(checked: boolean): void {
    this.selectedProfiles.update(prev => {
      const pageIds = this.paginatedProfiles().map(p => p.id);
      if (checked) {
        return [...new Set([...prev, ...pageIds])];
      } else {
        return prev.filter(pId => !pageIds.includes(pId));
      }
    });
  }
}
