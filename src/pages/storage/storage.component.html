
<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-wrap justify-between items-center gap-4 pb-4 border-b border-gray-200 dark:border-slate-700">
    <div>
      <h1 class="text-2xl font-bold text-[#293c51] dark:text-gray-200">Storage</h1>
      <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Manage your virtual disks, object storage, and snapshots.</p>
    </div>
  </div>

  <!-- Capacity Overview -->
  <div class="bg-white dark:bg-slate-800 rounded-xl shadow p-6">
    <h3 class="text-lg font-semibold text-[#293c51] dark:text-gray-200">Capacity Overview</h3>
    <p class="text-sm text-gray-500 dark:text-gray-400">Total provisioned storage across all services.</p>
    <div class="mt-4">
      <div class="flex justify-between items-center text-sm font-medium text-[#293c51] dark:text-gray-300">
        <span>{{ totalProvisionedStorage() }} GB Used</span>
        <span class="text-gray-500 dark:text-gray-400">{{ totalCapacity() / 1024 }} TB Total</span>
      </div>
      <div class="mt-2 bg-gray-200 dark:bg-slate-700 rounded-full h-2.5">
        <div class="bg-[#679a41] h-2.5 rounded-full" [style.width.%]="provisionedPercentage()"></div>
      </div>
    </div>
  </div>
  
  <!-- Tabs -->
  <div class="bg-white dark:bg-slate-800 rounded-xl shadow">
    <div class="border-b border-gray-200 dark:border-slate-700">
      <nav class="-mb-px flex space-x-6 px-6" aria-label="Tabs">
        <button (click)="setActiveTab('disks')"
                [class]="activeTab() === 'disks' ? 'border-[#679a41] text-[#679a41] dark:border-[#8cc866] dark:text-[#8cc866]' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-slate-600'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
          Disks
        </button>
        <button (click)="setActiveTab('objectStorage')"
                [class]="activeTab() === 'objectStorage' ? 'border-[#679a41] text-[#679a41] dark:border-[#8cc866] dark:text-[#8cc866]' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-slate-600'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
          Object Storage
        </button>
        <button (click)="setActiveTab('snapshots')"
                [class]="activeTab() === 'snapshots' ? 'border-[#679a41] text-[#679a41] dark:border-[#8cc866] dark:text-[#8cc866]' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-slate-600'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
          Snapshots
        </button>
      </nav>
    </div>

    <!-- Tab Content -->
    <div class="p-6">
      @switch (activeTab()) {
        @case ('disks') {
          <!-- Actions Bar -->
          <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
            <button (click)="openCreateDiskModal()" class="w-full sm:w-auto bg-[#679a41] text-white px-4 py-2 rounded-md text-sm font-semibold hover:bg-[#537d34] transition-all duration-200 ease-in-out flex items-center justify-center shadow-sm">
              <app-icon name="fas fa-plus" className="mr-2 text-xs"></app-icon>
              Create Disk
            </button>
            <div class="relative w-full sm:max-w-xs">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <app-icon name="fas fa-search" className="text-gray-400" />
              </div>
              <input type="text" [(ngModel)]="disksSearchTerm" placeholder="Search disks..."
                class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-1 focus:ring-[#679a41] sm:text-sm"
              />
            </div>
          </div>
          
          <!-- Disks Table -->
          <div class="shadow-sm sm:rounded-lg overflow-hidden border border-gray-200 dark:border-slate-700">
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-slate-700 dark:text-gray-400">
                <tr>
                  <th scope="col" class="px-6 py-3 cursor-pointer select-none" (click)="setDisksSort('name')">Name <app-icon [name]="disksSortDirection() === 'asc' ? 'fas fa-arrow-up' : 'fas fa-arrow-down'" [class.invisible]="disksSortColumn() !== 'name'" className="ml-2 w-3 h-3 inline-block"></app-icon></th>
                  <th scope="col" class="px-6 py-3 cursor-pointer select-none" (click)="setDisksSort('size')">Size <app-icon [name]="disksSortDirection() === 'asc' ? 'fas fa-arrow-up' : 'fas fa-arrow-down'" [class.invisible]="disksSortColumn() !== 'size'" className="ml-2 w-3 h-3 inline-block"></app-icon></th>
                  <th scope="col" class="px-6 py-3 cursor-pointer select-none" (click)="setDisksSort('type')">Type <app-icon [name]="disksSortDirection() === 'asc' ? 'fas fa-arrow-up' : 'fas fa-arrow-down'" [class.invisible]="disksSortColumn() !== 'type'" className="ml-2 w-3 h-3 inline-block"></app-icon></th>
                  <th scope="col" class="px-6 py-3 cursor-pointer select-none" (click)="setDisksSort('attachedTo')">Attached To <app-icon [name]="disksSortDirection() === 'asc' ? 'fas fa-arrow-up' : 'fas fa-arrow-down'" [class.invisible]="disksSortColumn() !== 'attachedTo'" className="ml-2 w-3 h-3 inline-block"></app-icon></th>
                  <th scope="col" class="px-6 py-3 cursor-pointer select-none" (click)="setDisksSort('creationDate')">Creation Date <app-icon [name]="disksSortDirection() === 'asc' ? 'fas fa-arrow-up' : 'fas fa-arrow-down'" [class.invisible]="disksSortColumn() !== 'creationDate'" className="ml-2 w-3 h-3 inline-block"></app-icon></th>
                  <th scope="col" class="px-6 py-3 text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (disk of filteredDisks(); track disk.id; let i = $index; let count = $count) {
                  <tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700">
                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ disk.name }}</td>
                    <td class="px-6 py-4">{{ disk.size }} GB</td>
                    <td class="px-6 py-4">{{ disk.type }}</td>
                    <td class="px-6 py-4">
                      @if(disk.attachedTo) {
                        <span class="font-medium text-sky-600 dark:text-sky-400">{{ disk.attachedTo }}</span>
                      } @else {
                        <span class="text-gray-400 italic">Unattached</span>
                      }
                    </td>
                    <td class="px-6 py-4">{{ disk.creationDate }}</td>
                    <td class="px-6 py-4 text-right">
                      <div class="relative inline-block action-menu-container">
                        <button (click)="toggleActionMenu(disk.id)" class="w-8 h-8 flex items-center justify-center rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
                          <app-icon name="fas fa-ellipsis-v"></app-icon>
                        </button>
                        @if (openActionMenuId() === disk.id) {
                          <div class="absolute right-0 w-48 rounded-md shadow-lg py-1 bg-white dark:bg-slate-800 ring-1 ring-black ring-opacity-5 z-10 text-left"
                               [class.origin-top-right]="i < count - 3"
                               [class.mt-2]="i < count - 3"
                               [class.origin-bottom-right]="i >= count - 3"
                               [class.bottom-full]="i >= count - 3"
                               [class.mb-2]="i >= count - 3">
                            @if (disk.attachedTo) {
                              <a href="#" (click)="$event.preventDefault(); handleDetachDisk(disk)" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-600">Detach</a>
                            } @else {
                              <a href="#" (click)="$event.preventDefault(); openAttachDiskModal(disk)" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-600">Attach</a>
                            }
                            <a href="#" (click)="$event.preventDefault(); handleCreateSnapshot(disk)" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-600">Create Snapshot</a>
                            <a href="#" (click)="$event.preventDefault(); openEditDiskModal(disk)" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-600">Resize Disk</a>
                            <a href="#" (click)="$event.preventDefault(); openDeleteDiskModal(disk)" class="block px-4 py-2 text-sm text-red-600 dark:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20">Delete</a>
                          </div>
                        }
                      </div>
                    </td>
                  </tr>
                } @empty {
                  <tr><td colspan="6" class="text-center p-6">No disks found.</td></tr>
                }
              </tbody>
            </table>
          </div>
        }
        @case ('objectStorage') {
           <!-- Actions Bar -->
          <div class="flex flex-col sm:flex-row justify-end items-center gap-4 mb-6">
            <button class="w-full sm:w-auto bg-[#679a41] text-white px-4 py-2 rounded-md text-sm font-semibold hover:bg-[#537d34] transition-colors flex items-center justify-center shadow-sm">
              <app-icon name="fas fa-plus" className="mr-2 text-xs"></app-icon>
              Create Bucket
            </button>
          </div>
          
          <!-- Buckets Table -->
          <div class="shadow-sm sm:rounded-lg overflow-hidden border border-gray-200 dark:border-slate-700">
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-slate-700 dark:text-gray-400">
                <tr>
                  <th scope="col" class="px-6 py-3">Bucket Name</th>
                  <th scope="col" class="px-6 py-3">Region</th>
                  <th scope="col" class="px-6 py-3">Access Level</th>
                  <th scope="col" class="px-6 py-3 text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (bucket of buckets(); track bucket.id; let i = $index; let count = $count) {
                  <tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700">
                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ bucket.name }}</td>
                    <td class="px-6 py-4">{{ bucket.region }}</td>
                    <td class="px-6 py-4">
                      @if (bucket.accessLevel === 'Public') {
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Public</span>
                      } @else {
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-200 text-gray-800 dark:bg-slate-600 dark:text-gray-200">Private</span>
                      }
                    </td>
                    <td class="px-6 py-4 text-right">
                      <div class="relative inline-block action-menu-container">
                        <button (click)="toggleActionMenu(bucket.id)" class="w-8 h-8 flex items-center justify-center rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
                          <app-icon name="fas fa-ellipsis-v"></app-icon>
                        </button>
                        @if (openActionMenuId() === bucket.id) {
                          <div class="absolute right-0 w-48 rounded-md shadow-lg py-1 bg-white dark:bg-slate-800 ring-1 ring-black ring-opacity-5 z-10 text-left"
                               [class.origin-top-right]="i < count - 3"
                               [class.mt-2]="i < count - 3"
                               [class.origin-bottom-right]="i >= count - 3"
                               [class.bottom-full]="i >= count - 3"
                               [class.mb-2]="i >= count - 3">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-600">Manage Files</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-600">Settings</a>
                            <a href="#" class="block px-4 py-2 text-sm text-red-600 dark:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20">Delete</a>
                          </div>
                        }
                      </div>
                    </td>
                  </tr>
                } @empty {
                  <tr><td colspan="4" class="text-center p-6">No buckets created.</td></tr>
                }
              </tbody>
            </table>
          </div>
        }
        @case ('snapshots') {
           <!-- Actions Bar -->
          <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
            <div></div>
            <div class="relative w-full sm:max-w-xs">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <app-icon name="fas fa-search" className="text-gray-400" />
              </div>
              <input type="text" [(ngModel)]="snapshotsSearchTerm" placeholder="Search snapshots..."
                class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-1 focus:ring-[#679a41] sm:text-sm"
              />
            </div>
          </div>
          
          <!-- Snapshots Table -->
          <div class="shadow-sm sm:rounded-lg overflow-hidden border border-gray-200 dark:border-slate-700">
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-slate-700 dark:text-gray-400">
                <tr>
                  <th scope="col" class="px-6 py-3 cursor-pointer select-none" (click)="setSnapshotsSort('name')">Snapshot Name <app-icon [name]="snapshotsSortDirection() === 'asc' ? 'fas fa-arrow-up' : 'fas fa-arrow-down'" [class.invisible]="snapshotsSortColumn() !== 'name'" className="ml-2 w-3 h-3 inline-block"></app-icon></th>
                  <th scope="col" class="px-6 py-3 cursor-pointer select-none" (click)="setSnapshotsSort('sourceDisk')">Source Disk <app-icon [name]="snapshotsSortDirection() === 'asc' ? 'fas fa-arrow-up' : 'fas fa-arrow-down'" [class.invisible]="snapshotsSortColumn() !== 'sourceDisk'" className="ml-2 w-3 h-3 inline-block"></app-icon></th>
                  <th scope="col" class="px-6 py-3 cursor-pointer select-none" (click)="setSnapshotsSort('size')">Size <app-icon [name]="snapshotsSortDirection() === 'asc' ? 'fas fa-arrow-up' : 'fas fa-arrow-down'" [class.invisible]="snapshotsSortColumn() !== 'size'" className="ml-2 w-3 h-3 inline-block"></app-icon></th>
                  <th scope="col" class="px-6 py-3 cursor-pointer select-none" (click)="setSnapshotsSort('creationTime')">Creation Time <app-icon [name]="snapshotsSortDirection() === 'asc' ? 'fas fa-arrow-up' : 'fas fa-arrow-down'" [class.invisible]="snapshotsSortColumn() !== 'creationTime'" className="ml-2 w-3 h-3 inline-block"></app-icon></th>
                  <th scope="col" class="px-6 py-3 text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (snapshot of filteredSnapshots(); track snapshot.id; let i = $index; let count = $count) {
                  <tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700">
                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ snapshot.name }}</td>
                    <td class="px-6 py-4">{{ snapshot.sourceDisk }}</td>
                    <td class="px-6 py-4">{{ snapshot.size }} GB</td>
                    <td class="px-6 py-4">{{ formatDate(snapshot.creationTime) }}</td>
                    <td class="px-6 py-4 text-right">
                      <div class="relative inline-block action-menu-container">
                        <button (click)="toggleActionMenu(snapshot.id)" class="w-8 h-8 flex items-center justify-center rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
                          <app-icon name="fas fa-ellipsis-v"></app-icon>
                        </button>
                        @if (openActionMenuId() === snapshot.id) {
                          <div class="absolute right-0 w-56 rounded-md shadow-lg py-1 bg-white dark:bg-slate-800 ring-1 ring-black ring-opacity-5 z-10 text-left"
                               [class.origin-top-right]="i < count - 3"
                               [class.mt-2]="i < count - 3"
                               [class.origin-bottom-right]="i >= count - 3"
                               [class.bottom-full]="i >= count - 3"
                               [class.mb-2]="i >= count - 3">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-600">Create Disk from Snapshot</a>
                            <a href="#" class="block px-4 py-2 text-sm text-red-600 dark:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20">Delete Snapshot</a>
                          </div>
                        }
                      </div>
                    </td>
                  </tr>
                } @empty {
                  <tr><td colspan="5" class="text-center p-6">No snapshots found.</td></tr>
                }
              </tbody>
            </table>
          </div>
        }
      }
    </div>
  </div>
</div>

<app-create-edit-disk-modal 
  [isOpen]="isCreateDiskModalOpen()"
  [diskToEdit]="diskToEdit()"
  [availableStorage]="availableStorage()"
  [availableVms]="availableVms()"
  (close)="closeDiskModal()"
  (save)="handleSaveDisk($event)">
</app-create-edit-disk-modal>

<app-delete-disk-modal
  [isOpen]="isDeleteDiskModalOpen()"
  [diskToDelete]="diskToDelete()"
  (close)="closeDeleteDiskModal()"
  (confirm)="handleConfirmDelete()">
</app-delete-disk-modal>

<app-attach-disk-modal
  [isOpen]="isAttachDiskModalOpen()"
  [diskToAttach]="diskToAttach()"
  [availableVms]="availableVms()"
  (close)="closeAttachDiskModal()"
  (confirmAttach)="handleConfirmAttach($event)">
</app-attach-disk-modal>
